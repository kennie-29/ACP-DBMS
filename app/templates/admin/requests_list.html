{% extends "base.html" %}

{% block content %}
<div class="container mt-5">
    <h2>Pending Funding Requests</h2>
    <p class="text-muted">
        {% if current_user.role == 'super_admin' %}
            As <strong>Captain</strong>, review officer votes before finalizing.
        {% else %}
            As <strong>Officer</strong>, cast your vote to advise the Captain.
        {% endif %}
    </p>

    <table class="table table-striped align-middle shadow-sm">
        <thead class="table-dark">
            <tr>
                <th>Project Details</th>
                <th>Requester</th>
                <th>Current Tally</th>
                <th>Your Action</th>
            </tr>
        </thead>
        <tbody>
            {% for req in requests %}
            <tr>
                <td style="width: 35%;">
                    <h5 class="mb-1">{{ req.project_title }}</h5>
                    <small class="text-muted">Site: {{ req.project_site }}</small><br>
                    <small class="text-primary fw-bold">‚Ç±{{ "{:,.2f}".format(req.fund_amount) }}</small>
                    <p class="mt-2 small">{{ req.reason }}</p>
                </td>
                
                <td>{{ req.requester.name }}<br><small class="text-muted">{{ req.requester.role }}</small></td>
                
                <td>
                    <div class="d-flex align-items-center gap-2">
                        <span class="badge bg-success rounded-pill">üëç {{ req.approve_count }}</span>
                        <span class="badge bg-danger rounded-pill">üëé {{ req.reject_count }}</span>
                    </div>
                    {% if current_user.role == 'super_admin' %}
                    <a href="#" class="small text-decoration-none mt-1 d-block" data-bs-toggle="modal" data-bs-target="#votesModal{{ req.request_id }}">See Remarks</a>
                    {% endif %}
                </td>

                <td>
                    {% if current_user.role == 'super_admin' %}
                        <div class="d-flex flex-column gap-2">
                            <form action="{{ url_for('admin.finalize_approval', request_id=req.request_id) }}" method="POST">
                                <button type="submit" name="action" value="Approve" class="btn btn-success btn-sm w-100">Final Approve</button>
                            </form>
                            <form action="{{ url_for('admin.finalize_approval', request_id=req.request_id) }}" method="POST">
                                <button type="submit" name="action" value="Reject" class="btn btn-outline-danger btn-sm w-100">Final Reject</button>
                            </form>
                        </div>

                    {% else %}
                        {% if req.user_voted %}
                            <span class="badge bg-secondary">You Voted: {{ req.user_voted.vote }}</span>
                        {% else %}
                            <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#voteModal{{ req.request_id }}">
                                Cast Vote
                            </button>
                        {% endif %}
                    {% endif %}
                </td>
            </tr>

            <div class="modal fade" id="voteModal{{ req.request_id }}" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Vote on: {{ req.project_title }}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <form action="{{ url_for('admin.cast_vote', request_id=req.request_id) }}" method="POST">
                            <div class="modal-body">
                                <div class="mb-3">
                                    <label>Remarks / Findings</label>
                                    <textarea name="remarks" class="form-control" rows="3" required placeholder="e.g., Site visited, costs look accurate."></textarea>
                                </div>
                                <div class="d-flex justify-content-center gap-3">
                                    <button type="submit" name="vote" value="Approve" class="btn btn-success flex-grow-1">Approve</button>
                                    <button type="submit" name="vote" value="Reject" class="btn btn-danger flex-grow-1">Reject</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <div class="modal fade" id="votesModal{{ req.request_id }}" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Vote Details: {{ req.project_title }}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <h6>Officer Remarks:</h6>
                            <ul class="list-group">
                                {% for vote in req.votes %}
                                <li class="list-group-item">
                                    <strong>{{ vote.admin.name }}:</strong> 
                                    <span class="badge bg-{{ 'success' if vote.vote == 'Approve' else 'danger' }}">{{ vote.vote }}</span>
                                    <br><span class="text-muted small">"{{ vote.remarks }}"</span>
                                </li>
                                {% else %}
                                <li class="list-group-item text-center">No votes cast yet.</li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            {% else %}
            <tr><td colspan="4" class="text-center">No pending requests.</td></tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}